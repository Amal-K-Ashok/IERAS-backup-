<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accident Authorization Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .header h1 {
            color: #333;
            font-size: 24px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            color: #666;
            font-weight: 500;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-logout {
            background: #e74c3c;
            color: white;
        }

        .btn-logout:hover {
            background: #c0392b;
        }

        .filters {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        .accidents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .accident-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .accident-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .accident-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .camera-id {
            font-weight: 600;
            color: #333;
            font-size: 16px;
        }

        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-uploaded {
            background: #cfe2ff;
            color: #084298;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .accident-info {
            margin: 15px 0;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }

        .info-label {
            color: #666;
        }

        .info-value {
            color: #333;
            font-weight: 500;
        }

        .severity {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 12px;
        }

        .severity-high {
            background: #dc3545;
            color: white;
        }

        .severity-medium {
            background: #ffc107;
            color: #333;
        }

        .severity-low {
            background: #28a745;
            color: white;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-view {
            flex: 1;
            background: #667eea;
            color: white;
        }

        .btn-view:hover {
            background: #5568d3;
        }

        .btn-approve {
            flex: 1;
            background: #28a745;
            color: white;
        }

        .btn-approve:hover {
            background: #218838;
        }

        .btn-reject {
            flex: 1;
            background: #dc3545;
            color: white;
        }

        .btn-reject:hover {
            background: #c82333;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .close-btn:hover {
            color: #333;
        }

        .video-container {
            width: 100%;
            margin: 20px 0;
            background: #000;
            border-radius: 5px;
            overflow: hidden;
        }

        video {
            width: 100%;
            max-height: 400px;
        }

        .video-loading {
            background: #cce5ff;
            color: #004085;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }

        .video-error {
            background: #f8d7da;
            color: #721c24;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }

        .video-url-display {
            font-size: 11px;
            color: #666;
            word-break: break-all;
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 3px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .detail-item {
            padding: 10px;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 10px;
            color: #666;
        }
    </style>
    <!-- Add Video.js library -->
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö® Accident Authorization Dashboard</h1>
            <div class="user-info">
                <span class="user-name" id="userName">Loading...</span>
                <button class="btn btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>

        <div class="filters">
            <button class="filter-btn active" onclick="filterAccidents('all')">All</button>
            <button class="filter-btn" onclick="filterAccidents('pending')">Pending</button>
            <button class="filter-btn" onclick="filterAccidents('UPLOADED')">Uploaded</button>
            <button class="filter-btn" onclick="filterAccidents('approved')">Approved</button>
            <button class="filter-btn" onclick="filterAccidents('rejected')">Rejected</button>
        </div>

        <div id="accidentsContainer">
            <div class="loading">Loading accidents...</div>
        </div>
    </div>

    <div id="videoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Accident Details</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        let currentFilter = 'all';
        let accidents = [];

        async function loadAccidents(status = null) {
            try {
                const url = status && status !== 'all' 
                    ? `/api/accidents?status=${status}` 
                    : '/api/accidents';
                
                const response = await fetch(url);
                const result = await response.json();
                
                if (result.success) {
                    accidents = result.data;
                    renderAccidents(accidents);
                }
            } catch (error) {
                console.error('Error loading accidents:', error);
                document.getElementById('accidentsContainer').innerHTML = 
                    '<div class="no-data">Error loading accidents</div>';
            }
        }

        function renderAccidents(accidents) {
            const container = document.getElementById('accidentsContainer');
            
            if (!accidents || accidents.length === 0) {
                container.innerHTML = '<div class="no-data">No accidents found</div>';
                return;
            }

            const grid = document.createElement('div');
            grid.className = 'accidents-grid';

            accidents.forEach(accident => {
                const card = createAccidentCard(accident);
                grid.appendChild(card);
            });

            container.innerHTML = '';
            container.appendChild(grid);
        }

        function createAccidentCard(accident) {
            const card = document.createElement('div');
            card.className = 'accident-card';

            const status = (accident.status || 'pending').toLowerCase();
            const statusClass = `status-${status}`;
            const severityClass = `severity-${(accident.severity || 'low').toLowerCase()}`;
            
            const timestamp = new Date(accident.timestamp).toLocaleString();
            
            // Show actions for pending and UPLOADED status
            const showActions = status === 'pending' || status === 'uploaded';

            card.innerHTML = `
                <div class="accident-header">
                    <div class="camera-id">üìπ ${accident.camera_id || 'Unknown'}</div>
                    <span class="status-badge ${statusClass}">${accident.status || 'pending'}</span>
                </div>
                <div class="accident-info">
                    <div class="info-row">
                        <span class="info-label">Severity:</span>
                        <span class="severity ${severityClass}">${accident.severity || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Location:</span>
                        <span class="info-value">${accident.latitude?.toFixed(4) || 'N/A'}, ${accident.longitude?.toFixed(4) || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Time:</span>
                        <span class="info-value">${timestamp}</span>
                    </div>
                    ${accident.authorized_by ? `
                    <div class="info-row">
                        <span class="info-label">Authorized By:</span>
                        <span class="info-value">${accident.authorized_by}</span>
                    </div>
                    ` : ''}
                </div>
                <div class="actions">
                    <button class="btn btn-view" onclick="viewAccident('${accident.id}')">View Details</button>
                    ${showActions ? `
                    <button class="btn btn-approve" onclick="approveAccident('${accident.id}')">‚úì Approve</button>
                    <button class="btn btn-reject" onclick="rejectAccident('${accident.id}')">‚úó Reject</button>
                    ` : ''}
                </div>
            `;

            return card;
        }

        async function viewAccident(accidentId) {
            try {
                const response = await fetch(`/api/accidents/${accidentId}`);
                const result = await response.json();
                
                if (result.success) {
                    const accident = result.data;
                    showModal(accident);
                }
            } catch (error) {
                console.error('Error loading accident details:', error);
                alert('Failed to load accident details');
            }
        }

        function showModal(accident) {
            const modal = document.getElementById('videoModal');
            const content = document.getElementById('modalContent');
            
            const videoUrl = accident.video_url || accident.clip_path;
            const timestamp = new Date(accident.timestamp).toLocaleString();
            
            const status = (accident.status || 'pending').toLowerCase();
            const statusClass = `status-${status}`;
            const severityClass = `severity-${(accident.severity || 'low').toLowerCase()}`;
            
            // Show actions for pending and UPLOADED status
            const showActions = status === 'pending' || status === 'uploaded';

            content.innerHTML = `
                ${videoUrl ? `
                <div class="video-container" id="videoWrapper">
                    <div class="video-loading">Loading video...</div>
                </div>
                <div class="video-url-display">
                    <strong>Video URL:</strong> ${videoUrl}
                </div>
                ` : '<div class="no-data">No video available</div>'}
                
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Camera ID</div>
                        <div class="detail-value">${accident.camera_id || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Status</div>
                        <div class="detail-value">
                            <span class="status-badge ${statusClass}">${accident.status || 'pending'}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Severity</div>
                        <div class="detail-value">
                            <span class="severity ${severityClass}">${accident.severity || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Timestamp</div>
                        <div class="detail-value">${timestamp}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Latitude</div>
                        <div class="detail-value">${accident.latitude?.toFixed(6) || 'N/A'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Longitude</div>
                        <div class="detail-value">${accident.longitude?.toFixed(6) || 'N/A'}</div>
                    </div>
                    ${accident.authorized_by ? `
                    <div class="detail-item">
                        <div class="detail-label">Authorized By</div>
                        <div class="detail-value">${accident.authorized_by}</div>
                    </div>
                    ` : ''}
                </div>
                
                ${showActions ? `
                <div class="actions" style="margin-top: 20px;">
                    <button class="btn btn-approve" onclick="approveAccident('${accident.id}')">‚úì Approve</button>
                    <button class="btn btn-reject" onclick="rejectAccident('${accident.id}')">‚úó Reject</button>
                </div>
                ` : ''}
            `;
            
            modal.classList.add('active');
            
            // Load video after modal is visible
            if (videoUrl) {
                loadVideo(videoUrl);
            }
        }

        let currentPlayer = null; // Track current video player
        
        function loadVideo(videoUrl) {
            const videoWrapper = document.getElementById('videoWrapper');
            
            if (!videoWrapper) return;
            
            console.log('üìπ Loading video with Video.js:', videoUrl);
            
            // Dispose of existing player if any
            if (currentPlayer) {
                try {
                    currentPlayer.dispose();
                    console.log('üóëÔ∏è Disposed previous player');
                } catch (e) {
                    console.warn('Could not dispose player:', e);
                }
                currentPlayer = null;
            }
            
            // Create unique video player ID
            const playerId = 'videoPlayer_' + Date.now();
            
            // Create video element with Video.js classes
            videoWrapper.innerHTML = `
                <video 
                    id="${playerId}" 
                    class="video-js vjs-default-skin" 
                    controls 
                    preload="auto" 
                    width="100%" 
                    style="max-height: 400px;">
                    <source src="${videoUrl}" type="video/mp4">
                    <p class="vjs-no-js">
                        To view this video please enable JavaScript, and consider upgrading to a
                        web browser that supports HTML5 video
                    </p>
                </video>
            `;
            
            // Initialize Video.js player
            try {
                currentPlayer = videojs(playerId, {
                    controls: true,
                    autoplay: false,
                    preload: 'auto',
                    fluid: true,
                    responsive: true
                });
                
                currentPlayer.ready(function() {
                    console.log('‚úÖ Video.js player ready');
                });
                
                currentPlayer.on('error', function(e) {
                    console.error('‚ùå Video.js error:', currentPlayer.error());
                    showVideoError('Video format not supported - needs re-encoding', videoUrl);
                });
                
                currentPlayer.on('loadeddata', function() {
                    console.log('‚úÖ Video loaded successfully with Video.js');
                });
                
            } catch (error) {
                console.error('‚ùå Video.js initialization error:', error);
                showVideoError('Failed to initialize video player', videoUrl);
            }
        }
        
        function showVideoError(message, videoUrl) {
            const videoWrapper = document.getElementById('videoWrapper');
            if (!videoWrapper) return;
            
            videoWrapper.innerHTML = `
                <div class="video-error">
                    <p><strong>‚ö†Ô∏è ${message}</strong></p>
                    <p style="margin-top: 10px; font-size: 12px;">
                        Your browser cannot play this video format.<br>
                        The video needs to be re-encoded to H.264 Baseline profile for browser compatibility.
                    </p>
                    <button class="btn btn-view" style="margin-top: 10px;" onclick="window.open('${videoUrl}', '_blank')">
                        Download Video
                    </button>
                </div>
            `;
        }

        function closeModal() {
            const modal = document.getElementById('videoModal');
            modal.classList.remove('active');
            
            // Dispose of video player when closing modal
            if (currentPlayer) {
                try {
                    currentPlayer.dispose();
                    console.log('üóëÔ∏è Disposed player on modal close');
                } catch (e) {
                    console.warn('Could not dispose player:', e);
                }
                currentPlayer = null;
            }
        }

        async function approveAccident(accidentId) {
            if (!confirm('Are you sure you want to approve this accident report?')) {
                return;
            }

            try {
                const response = await fetch(`/api/accidents/${accidentId}/approve`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Accident approved successfully!');
                    closeModal();
                    loadAccidents(currentFilter === 'all' ? null : currentFilter);
                } else {
                    alert('‚ùå Failed to approve accident: ' + result.message);
                }
            } catch (error) {
                console.error('Error approving accident:', error);
                alert('‚ùå Failed to approve accident');
            }
        }

        async function rejectAccident(accidentId) {
            if (!confirm('Are you sure you want to reject this accident report?')) {
                return;
            }

            try {
                const response = await fetch(`/api/accidents/${accidentId}/reject`, {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                    alert('‚úÖ Accident rejected successfully!');
                    closeModal();
                    loadAccidents(currentFilter === 'all' ? null : currentFilter);
                } else {
                    alert('‚ùå Failed to reject accident: ' + result.message);
                }
            } catch (error) {
                console.error('Error rejecting accident:', error);
                alert('‚ùå Failed to reject accident');
            }
        }

        function filterAccidents(status) {
            currentFilter = status;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadAccidents(status === 'all' ? null : status);
        }

        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Logout error:', error);
                window.location.href = '/login';
            }
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('videoModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Load accidents on page load
        window.onload = function() {
            loadAccidents();
        };
    </script>
</body>
</html>